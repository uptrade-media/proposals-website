# netlify.toml

[build]
  command   = "vite build"
  publish   = "dist"
  functions = "netlify/functions"

# ── Production-only security headers (no CSP in dev) ───────────────────────────
[context.production]

  # Cache static assets aggressively
  [[context.production.headers]]
    for = "/assets/*"
    [context.production.headers.values]
      Cache-Control = "public, max-age=31536000, immutable"
      X-Content-Type-Options = "nosniff"

  [[context.production.headers]]
    for = "/*"
    [context.production.headers.values]
      X-Frame-Options = "SAMEORIGIN"
      Content-Security-Policy = "default-src 'self'; base-uri 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; connect-src 'self' https://*.docusign.net https://*.docusign.com https://app.docusign.com; frame-src 'self' https://*.docusign.com https://*.docusign.net https://app.docusign.com; child-src https://*.docusign.com https://*.docusign.net; frame-ancestors 'self'; media-src 'self' https: data:; worker-src 'self' blob:; upgrade-insecure-requests"
      Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
      X-Content-Type-Options = "nosniff"
      Referrer-Policy = "strict-origin-when-cross-origin"
      Permissions-Policy = "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
      X-XSS-Protection = "1; mode=block"
      X-Permitted-Cross-Domain-Policies = "none"
      # Enable compression (Netlify does this automatically but explicit is good)
      Cache-Control = "public, max-age=0, must-revalidate"

  [[context.production.headers]]
    for = "/mbfm"
    [context.production.headers.values]
      Basic-Auth = "mbfm:Revenue2025"

# SPA fallback
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

[functions]
  node_bundler = "esbuild"
  included_files = ["netlify/functions/assets/**"]

# Scheduled function for generating recurring invoices
# Runs daily at 6:00 AM UTC (1:00 AM EST)
[functions."invoices-generate-recurring"]
  schedule = "0 6 * * *"

# Scheduled function for generating smart notifications
# Runs every 15 minutes
[functions."crm-notifications-generate"]
  schedule = "*/15 * * * *"

# Scheduled function for processing email follow-ups
# Runs every hour to check for due follow-ups and send them
[functions."scheduled-followups-process"]
  schedule = "0 * * * *"

[dev]
  framework     = "#custom"
  command       = "vite"
  targetPort    = 5173
  port          = 8888
  functionsPort = 9999
