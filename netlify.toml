# netlify.toml

[build]
  command   = "vite build"
  publish   = "dist"
  functions = "netlify/functions"

# ── Production-only security headers (no CSP in dev) ───────────────────────────
[context.production]

  # Cache static assets aggressively
  [[context.production.headers]]
    for = "/assets/*"
    [context.production.headers.values]
      Cache-Control = "public, max-age=31536000, immutable"
      X-Content-Type-Options = "nosniff"

  [[context.production.headers]]
    for = "/*"
    [context.production.headers.values]
      X-Frame-Options = "SAMEORIGIN"
      Content-Security-Policy = "default-src 'self'; base-uri 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; connect-src 'self' https://*.docusign.net https://*.docusign.com https://app.docusign.com; frame-src 'self' https://*.docusign.com https://*.docusign.net https://app.docusign.com; child-src https://*.docusign.com https://*.docusign.net; frame-ancestors 'self'; media-src 'self' https: data:; worker-src 'self' blob:; upgrade-insecure-requests"
      Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
      X-Content-Type-Options = "nosniff"
      Referrer-Policy = "strict-origin-when-cross-origin"
      Permissions-Policy = "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
      X-XSS-Protection = "1; mode=block"
      X-Permitted-Cross-Domain-Policies = "none"
      # Enable compression (Netlify does this automatically but explicit is good)
      Cache-Control = "public, max-age=0, must-revalidate"

  [[context.production.headers]]
    for = "/mbfm"
    [context.production.headers.values]
      Basic-Auth = "mbfm:Revenue2025"

# ── Unified API Router ─────────────────────────────────────────────────────────
# Route all /api/* requests to the unified router function
[[redirects]]
  from = "/api/*"
  to   = "/.netlify/functions/api/:splat"
  status = 200

# SPA fallback (must come AFTER more specific redirects)
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

[functions]
  node_bundler = "esbuild"
  included_files = ["netlify/functions/assets/**"]

# Scheduled function for generating recurring invoices
# Runs daily at 6:00 AM UTC (1:00 AM EST)
[functions."invoices-generate-recurring"]
  schedule = "0 6 * * *"

# Scheduled function for generating smart notifications
# Runs every 15 minutes
[functions."crm-notifications-generate"]
  schedule = "*/15 * * * *"

# Scheduled function for processing email follow-ups
# Runs every hour to check for due follow-ups and send them
[functions."scheduled-followups-process"]
  schedule = "0 * * * *"

# Scheduled function for processing job queue
# Runs every minute to process queued background jobs
[functions."job-queue-worker"]
  schedule = "* * * * *"

# Scheduled function for SEO automated analysis
# Runs daily at 2:00 AM UTC to process all sites with enabled schedules
[functions."seo-scheduled-run"]
  schedule = "0 2 * * *"

# Scheduled function for SEO jobs (ranking snapshots, reports, decay checks)
# Runs daily at 6:00 AM UTC
[functions."seo-scheduled-jobs"]
  schedule = "0 6 * * *"

# Scheduled function for measuring recommendation outcomes (AI learning)
# Runs daily at 4:00 AM UTC to measure outcomes of implemented recommendations
[functions."seo-ai-measure-outcomes-background"]
  schedule = "0 4 * * *"
  timeout = 900

# Scheduled function for monthly SEO reports
# Runs on the 1st of each month at 8:00 AM UTC
[functions."seo-monthly-reports-background"]
  schedule = "0 8 1 * *"
  timeout = 900

# Scheduled function for competitor monitoring
# Runs weekly on Thursdays at 3:00 AM UTC
[functions."seo-competitor-scheduled"]
  schedule = "0 3 * * 4"

[dev]
  framework     = "#custom"
  command       = "vite"
  targetPort    = 5173
  port          = 8888
  functionsPort = 9999

# ── Background Functions (15 min timeout) ───────────────────────────────────
# These functions can run for up to 15 minutes instead of 10-26 seconds

[functions."seo-cwv-background"]
  timeout = 900

[functions."seo-crawl-sitemap-background"]
  timeout = 900

[functions."seo-opportunities-detect-background"]
  timeout = 900

[functions."seo-ai-brain-background"]
  timeout = 900

# SEO AI Brain v2 - Uses OpenAI Assistants API with persistent threads
[functions."seo-ai-brain-v2-background"]
  timeout = 900

[functions."seo-ai-train-background"]
  timeout = 900

[functions."seo-ai-blog-brain-background"]
  timeout = 900

[functions."seo-metadata-extract-background"]
  timeout = 900

[functions."proposals-create-ai-background"]
  timeout = 900

[functions."proposals-edit-ai-background"]
  timeout = 900

[functions."audits-internal-background"]
  timeout = 900

# SEO Analysis Background Functions (from session)
[functions."seo-competitor-analyze-background"]
  timeout = 900

[functions."seo-content-brief-background"]
  timeout = 900

[functions."seo-cannibalization-background"]
  timeout = 900

[functions."seo-content-decay-background"]
  timeout = 900

[functions."seo-backlink-gap-background"]
  timeout = 900

[functions."seo-internal-links-background"]
  timeout = 900

[functions."seo-topic-clusters-background"]
  timeout = 900

[functions."seo-serp-features-background"]
  timeout = 900

[functions."seo-content-gap-analysis-background"]
  timeout = 900

[functions."seo-predictive-ranking-background"]
  timeout = 900

[functions."seo-schema-generate-background"]
  timeout = 900

[functions."seo-local-analyze-background"]
  timeout = 900

[functions."seo-title-ab-test-background"]
  timeout = 900

[functions."seo-backlinks-background"]
  timeout = 900

[functions."seo-serp-analyze-background"]
  timeout = 900

# Scheduled functions also need extended timeout
[functions."seo-scheduled-jobs"]
  timeout = 300

[functions."seo-scheduled-run"]
  timeout = 300
